<!-- C:\Users\Anonymous\Desktop\tele\templates\config.html -->
{% extends 'layout.html' %}

{% block content %}
<h2>系统配置</h2>
<p class="text-muted">在此处配置Telegram API信息和通知渠道（支持钉钉和企业微信机器人）。</p>

<div class="card mt-4">
    <div class="card-body">
        <form method="POST">
            <div class="mb-3">
                <label for="api_id" class="form-label">Telegram API ID</label>
                <input type="text" class="form-control" id="api_id" name="api_id" value="{{ config.api_id or '' }}" required>
                <div class="form-text">你的应用 API ID。</div>
            </div>
            <div class="mb-3">
                <label for="api_hash" class="form-label">Telegram API Hash</label>
                <input type="text" class="form-control" id="api_hash" name="api_hash" value="{{ config.api_hash or '' }}" required>
                <div class="form-text">你的应用 API Hash。</div>
            </div>
            <div class="mb-3">
                <label for="phone_number" class="form-label">手机号码</label>
                <input type="text" class="form-control" id="phone_number" name="phone_number" value="{{ config.phone_number or '' }}" placeholder="+国家代码手机号" required>
                <div class="form-text">用于登录Telegram的手机号，格式如：+8612345678901。</div>
            </div>
            <hr>
            <h5 class="mb-3">通知配置</h5>
            
            <div class="mb-3">
                <label class="form-label">通知渠道</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="notification_type" value="none" 
                           id="notification-none" {% if (config.notification_type or 'none') == 'none' %}checked{% endif %}>
                    <label class="form-check-label" for="notification-none">
                        不启用通知
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="notification_type" value="dingtalk" 
                           id="notification-dingtalk" {% if config.notification_type == 'dingtalk' %}checked{% endif %}>
                    <label class="form-check-label" for="notification-dingtalk">
                        钉钉机器人
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="notification_type" value="wecom" 
                           id="notification-wecom" {% if config.notification_type == 'wecom' %}checked{% endif %}>
                    <label class="form-check-label" for="notification-wecom">
                        企业微信机器人
                    </label>
                </div>
            </div>

            <!-- 钉钉配置（条件显示） -->
            <div id="dingtalk-config" style="display: none;">
                <div class="card mb-3 bg-light">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-comment-dots"></i> 钉钉机器人配置</h6>
                        <div class="mb-3">
                            <label for="dingtalk_webhook" class="form-label">Webhook地址</label>
                            <input type="text" class="form-control" id="dingtalk_webhook" name="dingtalk_webhook" 
                                   value="{{ config.dingtalk_webhook or '' }}" placeholder="https://oapi.dingtalk.com/robot/send?access_token=...">
                            <div class="form-text">钉钉机器人的Webhook地址</div>
                        </div>
                        <div class="mb-3">
                            <label for="dingtalk_secret" class="form-label">加签密钥（可选）</label>
                            <input type="text" class="form-control" id="dingtalk_secret" name="dingtalk_secret" 
                                   value="{{ config.dingtalk_secret or '' }}" placeholder="SEC...">
                            <div class="form-text">如果机器人开启了"加签"安全设置，请输入密钥</div>
                        </div>
                        <form action="{{ url_for('test_dingtalk') }}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-paper-plane"></i> 发送测试消息
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 企业微信配置（条件显示） -->
            <div id="wecom-config" style="display: none;">
                <div class="card mb-3 bg-light">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-comments"></i> 企业微信机器人配置</h6>
                        <div class="mb-3">
                            <label for="wecom_webhook" class="form-label">Webhook地址</label>
                            <input type="text" class="form-control" id="wecom_webhook" name="wecom_webhook" 
                                   value="{{ config.wecom_webhook or '' }}" placeholder="https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=...">
                            <div class="form-text">企业微信机器人的Webhook地址</div>
                        </div>
                        <form action="{{ url_for('test_wecom') }}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-paper-plane"></i> 发送测试消息
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">保存配置</button>
        </form>
    </div>
</div>

<!-- 新的、美化的监控状态卡片 -->
<div class="card mt-4">
    <div class="card-body">
        <h5 class="card-title">监控状态</h5>
        <div id="status-container" class="d-flex align-items-center p-3 rounded">
            <!-- JS动态填充 -->
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const statusContainer = document.getElementById('status-container');

    function updateStatus() {
        fetch('/status')
            .then(response => response.json())
            .then(data => {
                let content = '';
                if (data.is_running) {
                    statusContainer.className = 'd-flex align-items-center p-3 rounded bg-success-subtle text-success-emphasis';
                    content = `
                        <div class="spinner-grow spinner-grow-sm me-3" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>
                            <strong>运行中</strong>
                            <div class="small">监控服务已在后台成功启动。要停止，请关闭命令行窗口。</div>
                        </div>
                    `;
                } else {
                    statusContainer.className = 'd-flex align-items-center p-3 rounded bg-danger-subtle text-danger-emphasis';
                    content = `
                        <div class="me-3" style="width: 1rem; height: 1rem; background-color: currentColor; border-radius: 50%;"></div>
                        <div>
                            <strong>已停止</strong>
                            <div class="small">监控服务当前未运行。请重启程序以启动监控。</div>
                        </div>
                    `;
                }
                statusContainer.innerHTML = content;
            })
            .catch(error => {
                statusContainer.className = 'd-flex align-items-center p-3 rounded bg-warning-subtle text-warning-emphasis';
                statusContainer.innerHTML = '<div><strong>状态未知</strong><div class="small">无法获取后台服务状态。</div></div>';
                console.error('Error fetching status:', error);
            });
    }

    // 页面加载时立即更新一次，并在之后每5秒轮询一次
    updateStatus();
    setInterval(updateStatus, 5000);

    // 通知渠道切换逻辑
    function toggleNotificationConfig() {
        const selectedType = document.querySelector('input[name="notification_type"]:checked').value;
        const dingtalkConfig = document.getElementById('dingtalk-config');
        const wecomConfig = document.getElementById('wecom-config');
        
        // 隐藏所有配置
        dingtalkConfig.style.display = 'none';
        wecomConfig.style.display = 'none';
        
        // 显示选中的配置
        if (selectedType === 'dingtalk') {
            dingtalkConfig.style.display = 'block';
        } else if (selectedType === 'wecom') {
            wecomConfig.style.display = 'block';
        }
    }

    // 监听通知渠道单选框变化
    document.querySelectorAll('input[name="notification_type"]').forEach(radio => {
        radio.addEventListener('change', toggleNotificationConfig);
    });

    // 页面加载时根据当前配置显示
    toggleNotificationConfig();
});
</script>

{% endblock %}
