<!-- C:\Users\Anonymous\Desktop\tele\templates\groups.html -->
{% extends 'layout.html' %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>群组管理</h2>
    <div>
        <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#batchJoinModal">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-robot" viewBox="0 0 16 16"><path d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5ZM3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.58 26.58 0 0 0 4.94 0C11.765 5.765 13 6.76 13 8.062v1.157a.933.933 0 0 1-.765.935c-.845.147-2.34.346-4.235.346-1.895 0-3.39-.2-4.235-.346A.933.933 0 0 1 3 9.219V8.062Zm4.542-.827a.25.25 0 0 0-.217.068l-.92.9a24.767 24.767 0 0 1-1.871-.183.25.25 0 0 0-.068.495c.55.076 1.232.149 2.02.193a.25.25 0 0 0 .189-.071l.754-.736.847 1.71a.25.25 0 0 0 .404.062l.932-.97a25.286 25.286 0 0 0 1.922-.188.25.25 0 0 0-.068-.495c-.538.074-1.207.145-1.98.189a.25.25 0 0 0-.166.076l-.754.785-.842-1.7a.25.25 0 0 0-.182-.135Z"/><path d="M8.5 1.866a1 1 0 1 0-1 0V3h-2A4.5 4.5 0 0 0 1 7.5V8a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1v1a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-1a1 1 0 0 0 1-1V9a1 1 0 0 0-1-1v-.5A4.5 4.5 0 0 0 10.5 3h-2V1.866ZM14 7.5V13a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V7.5A3.5 3.5 0 0 1 5.5 4h5A3.5 3.5 0 0 1 14 7.5Z"/></svg>
            批量加群
        </button>
        <a href="{{ url_for('add_my_groups_page') }}" class="btn btn-success btn-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-lg" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
            </svg>
            从已加入的群组中添加
        </a>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">添加新群组</h5>
        <form method="POST" id="add-group-form" action="{{ url_for('groups') }}">
            <div class="input-group">
                <input type="text" class="form-control" name="group_identifier" placeholder="输入群组的公开链接 (如 https://t.me/...) 或用户名 (如 @...)" required>
                <button type="submit" class="btn btn-primary" id="add-group-btn">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    自动获取并添加
                </button>
            </div>
            <div class="form-text mt-2">
                系统将通过Telegram API自动获取群组的名称、ID和Logo。请确保监控服务已启动并成功登录过一次。
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <span>已监控的群组列表 (共 {{ pagination.total }} 个，当前第 {{ pagination.page }}/{{ pagination.pages }} 页)</span>
            <form action="{{ url_for('groups') }}" method="GET" style="width: 280px;">
                <div class="input-group">
                    <input class="form-control" type="search" placeholder="搜索群组名称..." name="q" value="{{ search_query or '' }}" aria-label="Search">
                    <button class="btn btn-secondary" type="submit">搜索</button>
                </div>
            </form>
        </div>
    </div>
    <div class="card-body">
        {% if groups %}
        <form action="{{ url_for('batch_delete_groups') }}" method="POST">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th style="width: 5%;"><input class="form-check-input" type="checkbox" id="select-all-groups-checkbox"></th>
                        <th style="width: 10%;">Logo</th>
                        <th style="width: 40%;">群组名称</th>
                        <th style="width: 30%;">群组ID</th>
                        <th style="width: 15%;" class="text-end">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for group in groups %}
                    <tr>
                        <td><input class="form-check-input group-checkbox" type="checkbox" name="group_ids" value="{{ group.id }}"></td>
                        <td>
                            {% if group.logo_path %}
                                <img src="{{ url_for('static', filename=group.logo_path) }}" alt="logo" width="40" height="40" class="rounded-circle">
                            {% else %}
                                <img src="https://via.placeholder.com/40/6c757d/FFFFFF?text={{ group.group_name[0] | upper }}" alt="logo" class="rounded-circle">
                            {% endif %}
                        </td>
                        <td class="text-truncate">{{ group.group_name }}</td>
                        <td><code class="user-select-all">{{ group.group_identifier }}</code></td>
                        <td class="text-end">
                             <a href="{{ url_for('delete_group', group_id=group.id) }}" class="btn btn-outline-danger btn-sm" onclick="return confirm('确定要删除吗？')">删除</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- 分页导航 -->
            {% if pagination.pages > 1 %}
            <nav aria-label="群组分页">
                <ul class="pagination justify-content-center mb-3">
                    <!-- 首页 -->
                    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('groups', page=1, q=search_query) }}">首页</a>
                    </li>
                    
                    <!-- 上一页 -->
                    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('groups', page=pagination.prev_num, q=search_query) if pagination.has_prev else '#' }}">上一页</a>
                    </li>
                    
                    <!-- 页码 -->
                    {% for page_num in pagination.iter_pages(left_edge=2, right_edge=2, left_current=2, right_current=2) %}
                        {% if page_num %}
                            <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('groups', page=page_num, q=search_query) }}">{{ page_num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- 下一页 -->
                    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('groups', page=pagination.next_num, q=search_query) if pagination.has_next else '#' }}">下一页</a>
                    </li>
                    
                    <!-- 末页 -->
                    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('groups', page=pagination.pages, q=search_query) }}">末页</a>
                    </li>
                </ul>
                
                <!-- 跳转到指定页 -->
                <div class="d-flex justify-content-center align-items-center gap-2 mb-3">
                    <span class="text-muted">跳转到</span>
                    <input type="number" class="form-control" id="jump-to-page-groups" min="1" max="{{ pagination.pages }}" value="{{ pagination.page }}" style="width: 80px;">
                    <button class="btn btn-outline-secondary btn-sm" onclick="jumpToPageGroups()">跳转</button>
                </div>
            </nav>
            {% endif %}
            
            <button type="submit" class="btn btn-danger" onclick="return confirm('确定要删除所有选中的群组吗？')">删除选中</button>
        </form>
        {% else %}
            <p class="text-center text-muted">
                {% if search_query %}
                没有找到匹配 "<strong>{{ search_query }}</strong>" 的群组。
                {% else %}
                还没有添加任何群组。
                {% endif %}
            </p>
        {% endif %}
    </div>
</div>

<!-- 批量加群 Modal -->
<div class="modal fade" id="batchJoinModal" tabindex="-1" aria-labelledby="batchJoinModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchJoinModalLabel">批量加群助手</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="batch-join-close-btn-top"></button>
            </div>
            <div class="modal-body">
                <div id="setup-view">
                    <div class="mb-3">
                        <label for="group-links" class="form-label">群组链接 (一行一个)</label>
                        <textarea class="form-control" id="group-links" rows="8" placeholder="例如:&#10;https://t.me/examplegroup1&#10;https://t.me/s/examplegroup2"></textarea>
                        <div class="form-text">建议单次任务不超过 20 个群组，以免增加账户风险。</div>
                    </div>
                    <div class="mb-3">
                        <label for="join-delay" class="form-label">加群间隔 (秒)</label>
                        <input type="number" class="form-control" id="join-delay" value="60">
                        <div class="form-text">为安全起见，建议间隔在 60-180 秒之间，最低不应低于 20 秒。</div>
                    </div>
                </div>
                <div id="progress-view" style="display: none;">
                    <p><strong>任务进度:</strong> <span id="progress-counter">0 / 0</span></p>
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            实时日志
                        </div>
                        <div class="card-body bg-light" style="max-height: 300px; overflow-y: auto;">
                            <pre id="log-output" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="batch-join-close-btn-bottom">取消</button>
                <button type="button" class="btn btn-primary" id="start-join-btn">开始执行</button>
                <button type="button" class="btn btn-danger" id="stop-join-btn" style="display: none;">紧急停止</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 关键修复：需要为单个添加的表单按钮重新绑定加载动画的逻辑
    const addGroupForm = document.getElementById('add-group-form');
    if(addGroupForm) {
        addGroupForm.addEventListener('submit', function() {
            var btn = document.getElementById('add-group-btn');
            var spinner = btn.querySelector('.spinner-border');
            
            btn.disabled = true;
            if(spinner) spinner.classList.remove('d-none');
            // 为了安全地修改文本，避免影响spinner，只修改文本节点
            btn.childNodes[2].textContent = ' 正在获取...';
        });
    }

    // 批量加群相关逻辑
    const batchJoinModal = new bootstrap.Modal(document.getElementById('batchJoinModal'));
    const setupView = document.getElementById('setup-view');
    const progressView = document.getElementById('progress-view');
    const startBtn = document.getElementById('start-join-btn');
    const stopBtn = document.getElementById('stop-join-btn');
    const closeBtnTop = document.getElementById('batch-join-close-btn-top');
    const closeBtnBottom = document.getElementById('batch-join-close-btn-bottom');
    const logOutput = document.getElementById('log-output');
    const progressBar = document.getElementById('progress-bar');
    const progressCounter = document.getElementById('progress-counter');

    let taskId = null;
    let intervalId = null;

    function resetModal() {
        setupView.style.display = 'block';
        progressView.style.display = 'none';
        startBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
        stopBtn.disabled = false;
        stopBtn.textContent = '紧急停止';
        closeBtnTop.disabled = false;
        closeBtnBottom.textContent = '取消';
        closeBtnBottom.disabled = false;
        logOutput.textContent = '';
        progressBar.style.width = '0%';
        progressCounter.textContent = '0 / 0';
        if (intervalId) {
            clearInterval(intervalId);
            intervalId = null;
        }
    }

    // 监听弹窗关闭事件以重置状态
    document.getElementById('batchJoinModal').addEventListener('hidden.bs.modal', resetModal);

    startBtn.addEventListener('click', function() {
        const links = document.getElementById('group-links').value;
        const delay = document.getElementById('join-delay').value;

        fetch("{{ url_for('start_batch_join') }}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ links: links, delay: parseInt(delay) })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('启动失败: ' + data.error);
                return;
            }
            taskId = data.task_id;
            
            // 切换视图
            setupView.style.display = 'none';
            progressView.style.display = 'block';
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            closeBtnBottom.textContent = '关闭';
            closeBtnBottom.disabled = true; // 任务进行中，禁用关闭
            closeBtnTop.disabled = true;

            // 开始轮询
            intervalId = setInterval(updateStatus, 2000);
        })
        .catch(error => alert('请求失败: ' + error));
    });

    stopBtn.addEventListener('click', function() {
        if (!taskId) return;
        
        stopBtn.disabled = true;
        stopBtn.textContent = '正在停止...';

        fetch(`/api/batch_join/stop/${taskId}`, { method: 'POST' })
            .catch(error => console.error('停止请求失败:', error));
    });

    function updateStatus() {
        if (!taskId) return;

        fetch(`/api/batch_join/status/${taskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    clearInterval(intervalId);
                    alert('获取状态失败: ' + data.error);
                    return;
                }
                
                // 更新日志
                logOutput.textContent = data.log.join('\n');
                logOutput.scrollTop = logOutput.scrollHeight;

                // 更新进度条
                const percent = data.total > 0 ? (data.current / data.total) * 100 : 0;
                progressBar.style.width = `${percent}%`;
                progressCounter.textContent = `${data.current} / ${data.total}`;

                // 检查任务是否结束
                if (['completed', 'error', 'stopped'].includes(data.status)) {
                    clearInterval(intervalId);
                    intervalId = null;
                    stopBtn.style.display = 'none';
                    closeBtnBottom.disabled = false;
                    closeBtnTop.disabled = false;
                }
            })
            .catch(error => {
                clearInterval(intervalId);
                console.error('状态更新请求失败:', error);
            });
    }

    // 新增：群组列表的全选/取消全选逻辑
    const selectAllGroupsCheckbox = document.getElementById('select-all-groups-checkbox');
    const groupCheckboxes = document.querySelectorAll('.group-checkbox');

    if(selectAllGroupsCheckbox && groupCheckboxes.length > 0) {
        selectAllGroupsCheckbox.addEventListener('click', function() {
            groupCheckboxes.forEach(cb => {
                cb.checked = selectAllGroupsCheckbox.checked;
            });
        });

        groupCheckboxes.forEach(cb => {
            cb.addEventListener('click', function() {
                if (!this.checked) {
                    selectAllGroupsCheckbox.checked = false;
                } else {
                    const allChecked = Array.from(groupCheckboxes).every(gcb => gcb.checked);
                    selectAllGroupsCheckbox.checked = allChecked;
                }
            });
        });
    }
});

// 分页跳转函数
function jumpToPageGroups() {
    const pageInput = document.getElementById('jump-to-page-groups');
    const pageNum = parseInt(pageInput.value);
    const searchQuery = "{{ search_query or '' }}";
    
    if (pageNum && pageNum > 0) {
        let url = "{{ url_for('groups') }}?page=" + pageNum;
        if (searchQuery) {
            url += "&q=" + encodeURIComponent(searchQuery);
        }
        window.location.href = url;
    }
}

// 支持Enter键跳转
document.addEventListener('DOMContentLoaded', function() {
    const jumpInput = document.getElementById('jump-to-page-groups');
    if (jumpInput) {
        jumpInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                jumpToPageGroups();
            }
        });
    }
});
</script>

{% endblock %}
